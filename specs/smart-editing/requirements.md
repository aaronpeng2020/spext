# 需求文档

## 介绍

本需求旨在为 VoiceInput 语音输入法添加智能编辑功能。目前系统使用 Whisper API 进行语音转文字的简单转写，新功能将根据识别文本的长度和用户配置，对文本进行智能处理，包括添加标点符号、修正错别字、支持自定义 Prompt 处理以及上下文补全等高级功能。

## 需求

### 需求 1 - 智能文本处理

**用户故事：** 作为一个用户，我希望系统能够智能地处理我的语音输入，对于长句子自动添加标点符号、修正错别字，让我的输入更加准确和自然。

#### 验收标准

1. When 识别的文本长度小于等于10个字符时，系统应当直接输入原始文本，不进行任何处理。
2. When 识别的文本长度大于10个字符时，系统应当将文本发送给 OpenAI API 进行智能编辑。
3. When 启用智能编辑功能时，系统应当自动为长句子添加合适的标点符号。
4. When 启用智能编辑功能时，系统应当修正明显的错别字或拼写错误。
5. When 用户在设置中禁用智能编辑功能时，系统应当始终直接输入原始文本。

### 需求 2 - 自定义 Prompt 支持

**用户故事：** 作为一个高级用户，我希望能够自定义文本处理的 Prompt，实现特定的文本转换需求，例如繁体转简体、格式化等。

#### 验收标准

1. When 用户在设置界面配置自定义 Prompt 时，系统应当保存该配置。
2. When 启用自定义 Prompt 且文本需要处理时，系统应当使用用户定义的 Prompt 发送给 OpenAI API。
3. When 自定义 Prompt 为空时，系统应当使用默认的智能编辑 Prompt。
4. 系统应当提供至少3个预设的 Prompt 模板供用户选择（如：标点符号优化、繁简转换、专业术语纠正）。

### 需求 3 - 上下文补全功能

**用户故事：** 作为一个用户，我希望系统能够记住我最近的输入内容，在需要时结合上下文进行智能补全或续写。

#### 验收标准

1. When 启用上下文功能时，系统应当保存最近5次的输入历史。
2. When 用户选择上下文补全模式时，系统应当将当前输入和历史输入一起发送给 AI 进行处理。
3. When 历史记录达到存储上限时，系统应当使用先进先出（FIFO）策略删除最旧的记录。
4. When 用户清除历史记录时，系统应当立即删除所有保存的输入历史。
5. 系统应当在内存中保存历史记录，程序重启后历史记录应当被清空。

### 需求 4 - API 配置管理

**用户故事：** 作为一个用户，我希望能够配置智能编辑功能使用的 API 参数，包括模型选择、超时设置等。

#### 验收标准

1. When 用户配置 OpenAI Chat API 端点时，系统应当保存并使用该配置。
2. When 用户配置 API 模型（如 gpt-3.5-turbo、gpt-4）时，系统应当使用指定的模型。
3. When API 调用超时时，系统应当降级到直接输入原始文本，并显示适当的警告。
4. 系统应当复用现有的 API 密钥和代理配置。

### 需求 5 - 用户界面更新

**用户故事：** 作为一个用户，我希望在设置界面中能够方便地配置所有智能编辑相关的选项。

#### 验收标准

1. 设置界面应当包含"智能编辑"选项卡或区域。
2. 界面应当提供以下配置项：
   - 启用/禁用智能编辑（开关）
   - 文本长度阈值（数字输入，默认10）
   - 自定义 Prompt（文本框）
   - Prompt 模板选择（下拉列表）
   - 启用/禁用上下文功能（开关）
   - 历史记录数量（数字输入，默认5）
   - API 模型选择（下拉列表）
   - 清除历史记录按钮
3. 所有配置更改应当立即生效，无需重启程序。

### 需求 6 - 性能和用户体验

**用户故事：** 作为一个用户，我希望智能编辑功能不会显著影响输入的响应速度。

#### 验收标准

1. When 智能编辑处理时间超过2秒时，系统应当显示处理中的提示。
2. When API 调用失败时，系统应当在500毫秒内降级到原始文本输入。
3. 系统应当支持取消正在进行的智能编辑处理。
4. While 等待智能编辑结果时，用户应当能够继续进行新的语音输入。